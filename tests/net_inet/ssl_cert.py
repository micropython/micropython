import socket
import ssl

if not hasattr(ssl, "CERT_REQUIRED"):
    print("SKIP")
    raise SystemExit

# This certificate was obtained from micropython.org using openssl:
# $ openssl s_client -showcerts -connect micropython.org:443 </dev/null 2>/dev/null
# The certificate is from Let's Encrypt:
# 1 s:C=US, O=Let's Encrypt, CN=R13
#   i:C=US, O=Internet Security Research Group, CN=ISRG Root X1
#   a:PKEY: RSA, 2048 (bit); sigalg: sha256WithRSAEncryption
#   v:NotBefore: Mar 13 00:00:00 2024 GMT; NotAfter: Mar 12 23:59:59 2027 GMT
# Copy PEM content to a file (mpycert.pem) and convert to DER e.g.
# $ openssl x509 -in mpycert.pem -out mpycert.der -outform DER
# Then convert to hex format using: for i in range(0,len(data),40):print(data[i:i+40].hex())

ca_cert_chain = bytes.fromhex(
    "30820505308202eda00302010202105a00f212d8d4b480f3924157ea298305300d06092a864886f7"
    "0d01010b0500304f310b300906035504061302555331293027060355040a1320496e7465726e6574"
    "2053656375726974792052657365617263682047726f7570311530130603550403130c4953524720"
    "526f6f74205831301e170d3234303331333030303030305a170d3237303331323233353935395a30"
    "33310b300906035504061302555331163014060355040a130d4c6574277320456e6372797074310c"
    "300a0603550403130352313330820122300d06092a864886f70d01010105000382010f003082010a"
    "0282010100a567708dd0568164151761cdb906d4ad19908c2650379816639254dbd9cc840593ecd3"
    "ec081ba0605143487d2bc748969eb42dda9dc8273b57a19fabf0d60ed40e30ca6f9bb1d1d6a49d32"
    "3e584e356f4558687117fc3ed85d82a02fb2516cb01a5db859ce3565c88ba1af1037ffe39c5dc249"
    "1734ff8c2b8b8df0bc712c930c1d05c4bac7cdaac95e7cd1c901f79c03f6fc0a5df4da7be6db7642"
    "70ebf44d22da00776fd6c95f17fdda752ea5570cf6ea5cb6e073a568cfa174e275827e109fc1f5a2"
    "eb01e938b10a44ccd3c289f54935820a34b31ce988c2474e820e0a36f0474f8af1290475dacde19a"
    "5cff5e9d9895ba9a43d04aa21705010430d332b38f0203010001a381f83081f5300e0603551d0f01"
    "01ff040403020186301d0603551d250416301406082b0601050507030206082b0601050507030130"
    "120603551d130101ff040830060101ff020100301d0603551d0e04160414e7ab9f0f2c33a053d35e"
    "4f78c8b2840e3bd69233301f0603551d2304183016801479b459e67bb6e5e40173800888c81a58f6"
    "e99b6e303206082b0601050507010104263024302206082b060105050730028616687474703a2f2f"
    "78312e692e6c656e63722e6f72672f30130603551d20040c300a3008060667810c01020130270603"
    "551d1f0420301e301ca01aa0188616687474703a2f2f78312e632e6c656e63722e6f72672f300d06"
    "092a864886f70d01010b0500038202010051375852a1229b35bb4dbaceca92ea09f2fb54ec187ff4"
    "3bf4e1f97072c265e8207d08437289e593b2a087c6f4be2fbf5ee5aeec237c9ff50f7a0d6fa371be"
    "b5a5e2aebcadb614229c01c6c1cfd475b3b28096bdcee05c572aa81f70974d70c89d3fbc6be73768"
    "454c2764adfa94a7e1e77e5a40e9f228ec8a3bc4c85c04e3b86e956d0bb738e0f5f395e4f9ab83fc"
    "f159b46e2fe9340c10c71097a79c2b007a7edcdf93e6c7b8e9989fc7b60461727cf4ca3481bf2230"
    "e8bd5022ea640afd9204e0d3ff10c3de07d04322afeaba15e06d8485f13202c5a99a88f18c25021a"
    "2ca0f7b16f0ed9bf34ad8b49cf65c9b2b107bdc8dbe3f61b709a5a9befa40887095bb7d235bc182c"
    "4a75f86c5ed9c8cb68a6b2442a559da6d0f9b1a1b6f6f13b9cafbc412bb0adc2f3eb6fbf68b3bbb6"
    "5cfdcee5ff5bfc7eba18dc91ae09515e5ad88c8d681982ff7f82359ff4a0bac75ae96bc0e82d7dd2"
    "4c63535e58d76987538f81c7247d731da18464bd7c08cc64a26cb36f2ac6fcfa031bb809a0e644d6"
    "692bfa50ad7175ef25c25e49845a0bd2384672e99f6971b2c854419c915fe255eab400ea36a6483d"
    "a78411232d2d2b676244434b485d8acac1706d8e81dba045785b37bf5b185518455bd9cb90ead056"
    "9a2b092d0ac9999fc150fcf6a49396772d2dc66721abe32ac294bb59c0d62534c9831d61ea4a47b9"
    "566e7c21771ddec289"
)


def main(use_stream=True):
    s = socket.socket()
    ai = socket.getaddrinfo("micropython.org", 443)
    addr = ai[0][-1]
    s.connect(addr)
    s = ssl.wrap_socket(
        s, cert_reqs=ssl.CERT_REQUIRED, cadata=ca_cert_chain, server_hostname="micropython.org"
    )
    s.write(b"GET / HTTP/1.0\r\n\r\n")
    print(s.read(17))
    s.close()


main()
